{% extends "base.html" %}

{% block title %}My Tickets - MuseumHub{% endblock %}

{% block content %}
<div class="modern-container">
    <div class="page-header">
        <h2 class="mb-3"><i class="fas fa-ticket-alt"></i> My Tickets</h2>
        <p class="subtitle">View and manage your booked tickets</p>
    </div>

    <div class="action-buttons mb-4">
        <a href="{{ url_for('calendar_page') }}" class="modern-btn primary">
            <i class="fas fa-calendar-plus"></i> Book New Visit
        </a>
        <a href="{{ url_for('chatbot') }}" class="modern-btn secondary">
            <i class="fas fa-robot"></i> Ask AI for Help
        </a>
    </div>

    {% if bookings %}
    <div class="bookings-grid">
        {% for booking in bookings %}
        <div class="modern-card booking-card">
            <div class="booking-header">
                <div class="booking-id">
                    <i class="fas fa-hashtag"></i> Booking #{{ booking.id }}
                </div>
                <div class="booking-status">
                    <span class="status-badge confirmed">
                        <i class="fas fa-check-circle"></i> Confirmed
                    </span>
                </div>
            </div>
            
            <div class="booking-details">
                <div class="detail-item">
                    <i class="fas fa-calendar-alt"></i>
                    <div>
                        <span class="label">Date</span>
                        <span class="value">{{ booking.date.strftime('%B %d, %Y') }}</span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-clock"></i>
                    <div>
                        <span class="label">Time Slot</span>
                        <span class="value">{{ booking.time_slot }}</span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-users"></i>
                    <div>
                        <span class="label">Visitors</span>
                        <span class="value">{{ booking.visitors }} {{ 'person' if booking.visitors == 1 else 'people' }}</span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-calendar-check"></i>
                    <div>
                        <span class="label">Booked On</span>
                        <span class="value">{{ booking.created_at.strftime('%B %d, %Y at %I:%M %p') if booking.created_at else 'N/A' }}</span>
                    </div>
                </div>
                
                <div class="detail-item">
                    <i class="fas fa-credit-card"></i>
                    <div>
                        <span class="label">Payment Status</span>
                        <span class="value">
                            {% if booking.payment_status == 'paid' %}
                                <span class="status-badge paid">
                                    <i class="fas fa-check-circle"></i> Paid
                                </span>
                            {% elif booking.payment_status == 'cash_pending' %}
                                <span class="status-badge cash-pending">
                                    <i class="fas fa-money-bill-wave"></i> Pay at Museum
                                </span>
                            {% elif booking.payment_status == 'pending' %}
                                <span class="status-badge pending">
                                    <i class="fas fa-clock"></i> Payment Pending
                                </span>
                            {% else %}
                                <span class="status-badge pending">
                                    <i class="fas fa-exclamation-circle"></i> Not Paid
                                </span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                {% if booking.amount %}
                <div class="detail-item">
                    <i class="fas fa-dollar-sign"></i>
                    <div>
                        <span class="label">Amount</span>
                        <span class="value">${{ "%.2f"|format(booking.amount) }} {{ booking.currency or 'USD' }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="booking-actions">
                {% if booking.payment_status != 'paid' %}
                <a href="{{ url_for('payment', booking_id=booking.id) }}" class="modern-btn primary" style="text-decoration: none;">
                    {% if booking.payment_status == 'cash_pending' %}
                        <i class="fas fa-credit-card"></i> Pay Online Now
                    {% else %}
                        <i class="fas fa-credit-card"></i> Pay Now
                    {% endif %}
                </a>
                {% endif %}
                <form method="post" action="{{ url_for('cancel_booking', booking_id=booking.id) }}" 
                      onsubmit="return confirm('Are you sure you want to cancel this booking? This action cannot be undone.');"
                      style="flex: 1; min-width: 150px;">
                    <button type="submit" class="modern-btn danger" style="width: 100%;">
                        <i class="fas fa-times-circle"></i> Cancel Booking
                    </button>
                        </form>
            </div>
        </div>
            {% endfor %}
    </div>
    
    <div class="booking-summary">
        <div class="summary-card">
            <h3><i class="fas fa-chart-bar"></i> Booking Summary</h3>
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-value">{{ bookings|length }}</span>
                    <span class="stat-label">Total Bookings</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">{% set total_visitors = bookings|sum(attribute='visitors') %}{{ total_visitors if total_visitors else 0 }}</span>
                    <span class="stat-label">Total Visitors</span>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-ticket-alt"></i>
        </div>
        <h3>No Bookings Yet</h3>
        <p>You haven't made any bookings yet. Start exploring and book your visit!</p>
        <div class="empty-actions">
            <a href="{{ url_for('calendar_page') }}" class="modern-btn primary">
                <i class="fas fa-calendar-plus"></i> Book Your First Visit
            </a>
            <a href="{{ url_for('view') }}" class="modern-btn secondary">
                <i class="fas fa-eye"></i> Explore Exhibits
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.modern-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.page-header {
    text-align: center;
    margin-bottom: 2rem;
}

.page-header h2 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 1.1rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.bookings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.booking-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
}

.booking-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(255, 0, 255, 0.3);
}

.booking-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.booking-id {
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.status-badge.confirmed {
    background: rgba(0, 255, 0, 0.2);
    color: #00ff00;
    border: 1px solid rgba(0, 255, 0, 0.3);
}

.status-badge.paid {
    background: rgba(0, 255, 0, 0.2);
    color: #00ff00;
    border: 1px solid rgba(0, 255, 0, 0.3);
}

.status-badge.pending {
    background: rgba(255, 165, 0, 0.2);
    color: #ffa500;
    border: 1px solid rgba(255, 165, 0, 0.3);
}

.status-badge.cash-pending {
    background: rgba(255, 165, 0, 0.2);
    color: #ffa500;
    border: 1px solid rgba(255, 165, 0, 0.3);
}

.booking-details {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.detail-item i {
    font-size: 1.2rem;
    color: #ff00ff;
    width: 30px;
}

.detail-item .label {
    display: block;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 0.25rem;
}

.detail-item .value {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: white;
}

.booking-actions {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.booking-actions .modern-btn {
    flex: 1;
    min-width: 150px;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    position: relative;
    z-index: 10;
    pointer-events: auto;
}

.booking-actions .modern-btn.primary {
    background: linear-gradient(45deg, #ff00ff, #ff1493);
    color: white;
    box-shadow: 0 5px 15px rgba(255, 0, 255, 0.3);
}

.booking-actions .modern-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 0, 255, 0.5);
}

.modern-btn.danger {
    background: linear-gradient(45deg, #ff4444, #cc0000);
    color: white;
    box-shadow: 0 5px 15px rgba(255, 68, 68, 0.3);
}

.modern-btn.danger:hover {
    background: linear-gradient(45deg, #ff6666, #ff0000);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 0, 0, 0.5);
}

.booking-actions form {
    flex: 1;
    min-width: 150px;
    display: inline-block;
    position: relative;
    z-index: 10;
    pointer-events: auto;
}

.booking-actions form button {
    width: 100%;
    position: relative;
    z-index: 10;
    pointer-events: auto;
    cursor: pointer;
}

.booking-summary {
    margin-top: 2rem;
}

.summary-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
}

.summary-card h3 {
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}

.summary-stats {
    display: flex;
    justify-content: space-around;
    gap: 2rem;
    flex-wrap: wrap;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #ff00ff;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
}

.empty-icon {
    font-size: 5rem;
    color: rgba(255, 255, 255, 0.3);
    margin-bottom: 1.5rem;
}

.empty-state h3 {
    font-size: 2rem;
    margin-bottom: 1rem;
}

.empty-state p {
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.8);
    margin-bottom: 2rem;
}

.empty-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .bookings-grid {
        grid-template-columns: 1fr;
    }
    
    .summary-stats {
        flex-direction: column;
    }
    
    .booking-actions {
        flex-direction: column;
    }
    
    .booking-actions .modern-btn,
    .booking-actions form {
        width: 100%;
    }
}
</style>

<script>
// Ensure buttons are clickable and forms work properly
document.addEventListener('DOMContentLoaded', function() {
    console.log('My Bookings page loaded');
    
    // Handle cancel booking form submission
    const cancelForms = document.querySelectorAll('form[action*="cancel_booking"]');
    console.log('Found cancel forms:', cancelForms.length);
    
    cancelForms.forEach((form, index) => {
        console.log('Setting up cancel form', index);
        
        // Remove existing onsubmit to avoid double confirmation
        form.onsubmit = null;
        
        form.addEventListener('submit', function(e) {
            console.log('Cancel form submitted');
            const confirmed = confirm('Are you sure you want to cancel this booking? This action cannot be undone.');
            if (!confirmed) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            // Allow form to submit normally
            return true;
        });
        
        // Ensure form button is clickable
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.addEventListener('click', function(e) {
                console.log('Cancel button clicked');
                // Let the form handle submission
            });
        }
    });
    
    // Ensure payment links work
    const paymentLinks = document.querySelectorAll('a[href*="/payment/"]');
    console.log('Found payment links:', paymentLinks.length);
    
    paymentLinks.forEach((link, index) => {
        console.log('Payment link', index, ':', link.href);
        link.addEventListener('click', function(e) {
            console.log('Payment link clicked:', this.href);
            // Link should work normally - don't prevent default
        });
        
        // Ensure link is clickable
        link.style.pointerEvents = 'auto';
        link.style.cursor = 'pointer';
        link.style.zIndex = '10';
        link.style.position = 'relative';
    });
    
    // Debug: Log all buttons
    const allButtons = document.querySelectorAll('.booking-actions button, .booking-actions a');
    console.log('All action buttons:', allButtons.length);
    allButtons.forEach((btn, i) => {
        console.log(`Button ${i}:`, btn.tagName, btn.className, btn.href || btn.type);
        btn.style.pointerEvents = 'auto';
        btn.style.cursor = 'pointer';
    });
});
</script>
{% endblock %}
